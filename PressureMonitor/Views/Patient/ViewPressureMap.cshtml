@model PressureMonitor.Models.PressureMap
@{
    ViewData["Title"] = "Pressure Map - " + Model.Day.ToString("MM/dd/yyyy");
    var formattedDay = Model.Day.ToString("MM/dd/yyyy");
}

<style>
    .page-title {
        font-size: 2rem;
        font-weight: bold;
        color: #13438b;
        margin-bottom: 20px;
    }
    
    .time-filter-section {
        display: flex;
        gap: 0;
        margin-bottom: 20px;
        border: 2px solid #333;
    }
    .time-btn {
        flex: 1;
        padding: 10px 15px;
        border: none;
        border-right: 2px solid #333;
        background: #fff;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.2s;
    }
    .time-btn:last-child {
        border-right: none;
    }
    .time-btn:hover {
        background: #f0f0f0;
    }
    .time-btn.active {
        background: #e0e0e0;
        font-weight: bold;
    }
    
    .main-layout {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
    }
    @@media (max-width: 992px) {
        .main-layout {
            grid-template-columns: 1fr;
        }
    }
    
    .left-column {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .data-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    @@media (max-width: 768px) {
        .data-row {
            grid-template-columns: 1fr;
        }
    }
    
    .heatmap-section, .graph-section {
        border: 2px solid #333;
        padding: 10px;
        position: relative;
    }
    .graph-section {
        display: flex;
        flex-direction: column;
    }
    .graph-container {
        flex: 1;
        position: relative;
        min-height: 250px;
    }
    .section-title {
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }
    .heatmap-container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .heatmap-legend {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.75rem;
    }
    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    .legend-dot.cyan { background: hsl(180, 100%, 50%); }
    .legend-dot.green { background: hsl(120, 100%, 50%); }
    .legend-dot.yellow { background: hsl(60, 100%, 50%); }
    .legend-dot.red { background: hsl(0, 100%, 50%); }
    
    .metrics-section {
        border: 2px solid #333;
        padding: 15px;
    }
    .metrics-title {
        font-weight: bold;
        margin-bottom: 10px;
    }
    .metrics-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }
    .metric-item {
        font-size: 0.85rem;
    }
    .help-icon {
        width: 14px;
        height: 14px;
        border: 1px solid #333;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.65rem;
        cursor: help;
    }
    
    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 15px;
    }
    .action-btn {
        padding: 10px 20px;
        border: 2px solid #333;
        font-weight: bold;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        color: #000;
    }
    .action-btn:hover {
        opacity: 0.9;
    }
    .btn-download { background: #fff; }
    .btn-flag { background: #90EE90; }
    .btn-edit { background: #FFD700; }
    .btn-delete { background: #FF6347; color: #fff; }
    
    .report-form {
        display: flex;
        gap: 0;
        align-items: stretch;
        width: 100%;
    }
    
    .report-format-select {
        flex: 1;
        padding: 10px 20px;
        border: 2px solid #333;
        border-right: none;
        font-weight: bold;
        background: #fff;
        cursor: pointer;
        font-family: inherit;
        text-align: center;
    }
    
    .report-submit-btn {
        flex: 1;
        border-left: 2px solid #333;
    }
    
    .comments-section {
        border: 2px solid #333;
        padding: 15px;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .comments-title {
        font-weight: bold;
        text-align: center;
        padding-bottom: 10px;
        border-bottom: 1px solid #333;
        margin-bottom: 15px;
    }
    .comments-list {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 15px;
    }
    .comment-item {
        margin-bottom: 15px;
    }
    .comment-author {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 5px;
    }
    .author-icon {
        width: 24px;
        height: 24px;
        border: 1px solid #333;
        border-radius: 50%;
    }
    .comment-text {
        padding: 8px 12px;
        border: 1px solid #ccc;
        background: #f9f9f9;
        font-size: 0.85rem;
        margin-bottom: 5px;
    }
    .reply-btn {
        padding: 5px 15px;
        border: 2px solid #333;
        background: #fff;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.85rem;
    }
    .reply-btn:hover {
        background: #f0f0f0;
    }
    
    .new-comment-section {
        border-top: 1px solid #ccc;
        padding-top: 15px;
    }
    .new-comment-section label {
        font-size: 0.85rem;
        margin-bottom: 5px;
        display: block;
    }
    .new-comment-section textarea {
        width: 100%;
        height: 60px;
        border: 1px solid #ccc;
        padding: 8px;
        margin-bottom: 10px;
        resize: none;
    }
    .comment-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .flag-checkbox {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.85rem;
    }
    .flag-checkbox a {
        color: #FF6347;
        text-decoration: underline;
    }
    .send-btn {
        padding: 8px 25px;
        border: 2px solid #333;
        background: #fff;
        font-weight: bold;
        cursor: pointer;
    }
    .send-btn:hover {
        background: #f0f0f0;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    .loading-overlay.hidden {
        display: none;
    }
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #13438b;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    .report-format {
        flex: 1;
        padding: 10px;
        border: 2px solid #333;
        font-weight: bold;
        background: #fff;
        cursor: pointer;
    }
    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div class="container-fluid">
    <h1 class="page-title">Viewing Pressure Map: @formattedDay</h1>
    
    <!-- Time Filter Buttons -->
    <div class="time-filter-section">
        <button type="button" class="time-btn range-btn" data-hours="1">Last 1h</button>
        <button type="button" class="time-btn range-btn" data-hours="3">Last 3h</button>
        <button type="button" class="time-btn range-btn" data-hours="6">Last 6h</button>
        <button type="button" class="time-btn range-btn" data-hours="12">Last 12h</button>
        <button type="button" class="time-btn range-btn active" data-hours="24">Full Day</button>
    </div>
    
    <div class="main-layout">
        <!-- Left Column -->
        <div class="left-column">
            <!-- Heatmap and Graph Row -->
            <div class="data-row">
                <!-- Heatmap Section -->
                <div class="heatmap-section">
                    <div class="loading-overlay hidden" id="heatmapLoading">
                        <div class="spinner"></div>
                    </div>
                    <div class="section-title">Heat Map Diagram - Average Pressure</div>
                    <div class="heatmap-container">
                        <canvas id="heatmapCanvas"></canvas>
                        <h5 id="hidden-canvas-error" hidden style="color: #999; font-size: 0.9rem;">No data for this time range.</h5>
                        <div class="heatmap-legend">
                            <div class="legend-item"><span class="legend-dot cyan"></span> 0-64</div>
                            <div class="legend-item"><span class="legend-dot green"></span> 65-128</div>
                            <div class="legend-item"><span class="legend-dot yellow"></span> 129-192</div>
                            <div class="legend-item"><span class="legend-dot red"></span> 193-255</div>
                        </div>
                    </div>
                </div>
                
                <!-- Graph Section -->
                <div class="graph-section">
                    <div class="loading-overlay hidden" id="graphLoading">
                        <div class="spinner"></div>
                    </div>
                    <div class="section-title">Peak Pressure Graph</div>
                    <div class="graph-container">
                        <canvas id="peakChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Metrics and Actions Row -->
            <div class="data-row">
                <!-- Key Metrics -->
                <div class="metrics-section">
                    <div class="metrics-title">Key Metrics</div>
                    <div class="metrics-grid">
                        <div class="metric-item">Lowest Pressure: <span id="minValue">-</span></div>
                        <div class="metric-item"><span class="help-icon">?</span> Contact Area: <span id="contactArea">-</span></div>
                        <div class="metric-item">Highest Pressure: <span id="maxValue">-</span></div>
                        <div class="metric-item"><span class="help-icon">?</span> Peak Pressure: <span id="peakPressure">-</span></div>
                        <div class="metric-item">Average Pressure: <span id="avgValue">-</span></div>
                        <div class="metric-item">Duration: <span id="duration">-</span></div>
                        <div class="metric-item">Pressure Range: <span id="pressureRange">-</span></div>
                        <div class="metric-item">Hover Data: <span id="hoverValue">-</span></div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="metrics-section">
                    <div class="action-buttons">
                        <a asp-controller="File" asp-action="DownloadCsv" asp-route-day="@Model.Day.ToString("yyyy-MM-dd")" class="action-btn btn-download">DOWNLOAD</a>
                        <button class="action-btn btn-flag" id="flagBtn">FLAG</button>
                        <!-- This will allow the user to download reports usinbg different method types-->
                        <form asp-controller="File" asp-action="DownloadReport" method="get" class="report-form">
                            <!-- Hidden but used for parsing through to the controller -->
                            <input type="hidden" name="day" value="@Model.Day.ToString("yyyy-MM-dd")" />
                            <select name="format" class="report-format-select">
                                <option value="txt">Text (.txt)</option>
                                <option value="docx">Word (.docx)</option>
                                <option value="pdf">PDF (.pdf)</option>
                            </select>
                            <button type="submit" class="action-btn btn-edit report-submit-btn">VIEW REPORT</button>
                        </form>
                        <a asp-action="Index" class="action-btn btn-delete">BACK</a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column - Comments -->
        <div class="comments-section">
            <div class="comments-title">Comments and Feedback</div>
            <div class="comments-list" id="commentsList">
                <!-- Example comments - will be populated dynamically -->
                <div class="comment-item">
                    <div class="comment-author">
                        <div class="author-icon"></div>
                        <strong>Example User</strong>
                    </div>
                    <div class="comment-text">Example Comment...</div>
                </div>
                <div class="comment-item">
                    <div class="comment-author">
                        <div class="author-icon"></div>
                        <strong>Clinician (reply)</strong>
                    </div>
                    <div class="comment-text">Example Comment...</div>
                    <button class="reply-btn">Reply</button>
                </div>
            </div>
            
            <div class="new-comment-section">
                <label>Create New Comment...</label>
                <textarea id="commentInput" placeholder="..."></textarea>
                <div class="comment-actions">
                    <label class="flag-checkbox">
                        <input type="checkbox" id="urgentFlag">
                        Flag for <a href="#">urgent review</a>
                    </label>
                    <button class="send-btn" id="sendCommentBtn">SEND</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

@section Scripts {
    <script>
        const day = '@Model.Day.ToString("yyyy-MM-dd")';
        let peakChart;
        let currentPeakValue = 0;
        
        // Loading spinner functions
        function showLoading(elementId) {
            document.getElementById(elementId)?.classList.remove('hidden');
        }
        function hideLoading(elementId) {
            document.getElementById(elementId)?.classList.add('hidden');
        }

        // Fetch the peak data for the given day and time range selected.
        // The data received is JSON and follows format of day, rangeStart, rangeEnd and points[]
        async function fetchPeakData(options = {}) {
            const params = new URLSearchParams({ day });
            if (options.hoursBack) {
                params.append('hoursBack', options.hoursBack);
            }
            if (options.from && options.to) {
                params.append('from', options.from);
                params.append('to', options.to);
            }
            // Calls the backend method and follows the parameters
            const res = await fetch(`/PressureMap/GetGraphData?${params.toString()}`);
            if (!res.ok) return null;
            return await res.json();
        }

        /* 
            Creates the line chart
            Labels - array of string labels for the X axis
            Data - array of numeric values for the Y axis
        */
        function buildChart(labels, data) {
            const ctx = document.getElementById('peakChart').getContext('2d');
            // If a previous one exists, we remove it first
            if (peakChart) {
                peakChart.destroy();
            }
            // Followed documentation from the Chart.js website
            peakChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Peak Pressure',
                        data,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13,110,253,0.15)',
                        tension: 0.35,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time (in minutes)' },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Peak Pressure' }
                        }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
            // Update peak pressure metric
            if (data.length > 0) {
                currentPeakValue = Math.max(...data);
                document.getElementById('peakPressure').textContent = currentPeakValue;
            } else {
                document.getElementById('peakPressure').textContent = '-';
            }
        }

        // Load graph independently
        async function loadGraph(options = {}) {
            showLoading('graphLoading');
            try {
                const result = await fetchPeakData(options);
                if (!result || result.points.length === 0) {
                    buildChart([], []);
                    return;
                }
                const labels = result.points.map(p => new Date(p.t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                const values = result.points.map(p => p.v);
                buildChart(labels, values);
            } finally {
                hideLoading('graphLoading');
            }
        }

        // Load both graph and heatmap
        function loadDay(options = {}) {
            loadGraph(options);
            loadHeatmap(options);
        }

        // Just a util to combine yyyy-MM-dd and HH:mm into ISO format
        function buildDateTime(dayStr, hhmm) {
            return `${dayStr}T${hhmm}:00`;
        }

        // Quick range buttons
        document.querySelectorAll('.range-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update active state
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const hours = btn.getAttribute('data-hours');
                loadDay({ hoursBack: hours });
            });
        });
    </script>
        
    <script>
        // Heatmap functionality
        const heatmapCanvas = document.getElementById('heatmapCanvas');
        const heatmapCtx = heatmapCanvas.getContext('2d');

        // Constants
        const MAX_PRESSURE_VALUE = 255;
        const GRID_SIZE = 32;
        const CELL_PIXEL_SIZE = 12;

        // Set canvas size so the pressure map fits correctly
        heatmapCanvas.width = GRID_SIZE * CELL_PIXEL_SIZE;
        heatmapCanvas.height = GRID_SIZE * CELL_PIXEL_SIZE;
        
        /**
         * Converts a pressure value (0-255) to an HSL color.
         * Mapping: 
         * 0   -> Blue (Hue 240)
         * 128 -> Green (Hue 120)
         * 255 -> Red (Hue 0)
         */
        function translateColor(pressure) {
            const adjusted = Math.min(pressure / MAX_PRESSURE_VALUE, 1.0);
            // Hue goes from 240 (blue) to 0 (red) - inverted
            const hue = Math.floor(240 * (1 - adjusted));
            return `hsl(${hue}, 100%, 50%)`;
        }

        // Draw the heatmap
        function drawHeatmap(data) {
            // Clear prior drawing (incase there was a prior heat map)
            heatmapCtx.clearRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);
            if (!data || data.length !== 32) {
                console.error('Invalid data for rendering, must be a 32x32 matrix.');
                return;
            }
            // We know that the value range is 0 - 256 so we can define min/max.
            let min = 257;
            let max = -1;
            let sum = 0;
            let count = 0;
            let activePixels = 0;
            // Single loop to calculate metrics and draw the heatmap
            for (let row = 0; row < GRID_SIZE; row++) {
                for (let col = 0; col < GRID_SIZE; col++) {
                    const value = data[row][col];
                    // Calculate metrics
                    min = Math.min(min, value);
                    max = Math.max(max, value);
                    sum += value;
                    count++;
                    if (value > 15) activePixels++;
                    // Draw the cell
                    heatmapCtx.fillStyle = translateColor(value);
                    heatmapCtx.fillRect(col * CELL_PIXEL_SIZE, row * CELL_PIXEL_SIZE, CELL_PIXEL_SIZE, CELL_PIXEL_SIZE);
                }
            }
            const average = Math.round(sum / count);
            const totalPixels = GRID_SIZE * GRID_SIZE;
            const contactAreaPercentage = ((activePixels / totalPixels) * 100).toFixed(1);
            // Update the metrics display
            document.getElementById('minValue').textContent = min;
            document.getElementById('maxValue').textContent = max;
            document.getElementById('avgValue').textContent = average;
            document.getElementById('contactArea').textContent = `${contactAreaPercentage}%`;
            document.getElementById('pressureRange').textContent = min + " - " + max;
            // Cache the matrix data for the hover logic
            heatmapCanvas.heatmapData = data;
        }

        // Handle mouse hover to show cell value
        heatmapCanvas.addEventListener('mousemove', (e) => {
            if (!heatmapCanvas.heatmapData) return;
            
            // We need to check if the mouse location is within the canvas
            const rect = heatmapCanvas.getBoundingClientRect();
            const scaleX = heatmapCanvas.width / rect.width;
            const scaleY = heatmapCanvas.height / rect.height;
            
            // Get mouse position relative to canvas
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            // By dividing, we can find the cell indices
            const col = Math.floor(x / CELL_PIXEL_SIZE);
            const row = Math.floor(y / CELL_PIXEL_SIZE);
            
            // Ensure that the indicies are within the bounds
            if (row >= 0 && row < GRID_SIZE && col >= 0 && col < GRID_SIZE) {
                // Check the matrix data for the pressure value
                const value = heatmapCanvas.heatmapData[row][col];
                document.getElementById('hoverValue').textContent = `${value} (Row: ${row}, Col: ${col})`;
            }
        });

        heatmapCanvas.addEventListener('mouseleave', () => {
            document.getElementById('hoverValue').textContent = '-';
        });
        
        function clearHeatmapDisplay() {
            // Clear all metrics and the heatmap
            heatmapCtx.clearRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);
            heatmapCanvas.heatmapData = null;
            document.getElementById('minValue').textContent = '-';
            document.getElementById('maxValue').textContent = '-';
            document.getElementById('avgValue').textContent = '-';
            document.getElementById('pressureRange').textContent = '-';
            document.getElementById('contactArea').textContent = '-';
            document.getElementById('peakPressure').textContent = '-';
            document.getElementById('duration').textContent = '-';
            document.getElementById('hoverValue').textContent = '-';
        }
        
        // Load heatmap data for the selected day and time range
        async function loadHeatmap(options = {}) {
            showLoading('heatmapLoading');
            const errorElement = document.getElementById("hidden-canvas-error");
            try {
                const params = new URLSearchParams({ day });
                if (options.hoursBack) params.append('hoursBack', options.hoursBack);
                if (options.from) params.append('from', options.from);
                if (options.to) params.append('to', options.to);
                const response = await fetch(`/PressureMap/GetAverage?${params}`);
                const result = await response.json();
                // Gets the matrix data of the average map
                if (result && result.averageMap && result.averageMap.length === 32) {
                    errorElement.hidden = true;
                    heatmapCanvas.hidden = false;
                    drawHeatmap(result.averageMap);
                    // Display duration from frame count
                    if (result.durationSeconds !== undefined) {
                        const totalSeconds = result.durationSeconds;
                        const minutes = Math.floor(totalSeconds / 60);
                        const seconds = totalSeconds % 60;
                        document.getElementById('duration').textContent = `${minutes}m ${seconds}s`;
                    } else {
                        document.getElementById('duration').textContent = '-';
                    }
                } else {
                    // No data for this range - clear the canvas and show this message
                    errorElement.hidden = false;
                    heatmapCanvas.hidden = true;
                    clearHeatmapDisplay();
                }
            } catch (error) {
                // Error occurred - clear the canvas and show no data message
                console.error('Error loading heatmap:', error);
                errorElement.hidden = false;
                heatmapCanvas.hidden = true;
                clearHeatmapDisplay();
            } finally {
                hideLoading('heatmapLoading');
            }
        }
        // Initialize both graph and heatmap on page load
        loadDay({ hoursBack: 24 });
    </script>
}

