@model PressureMonitor.Models.PressureMap
@{
    ViewData["Title"] = "Pressure Map - " + Model.Day.ToString("yyyy-MM-dd");
}

<div class="container-fluid">
    <h1 class="display-4 text-center">Pressure Map</h1>
    <p class="text-center">Day: @Model.Day.ToString("yyyy-MM-dd")</p>
    
    <div class="card mt-4" style="border-bottom-left-radius: 0; border-bottom-right-radius: 0; border-bottom: 0;">
        <div class="card-body">
            <div style="display: grid; gap: 8px; grid-template-columns: repeat(5, 1fr); margin-bottom: 8px;">
                <button type="button" class="btn btn-outline-secondary range-btn" data-hours="1">Last 1h</button>
                <button type="button" class="btn btn-outline-secondary range-btn" data-hours="3">Last 3h</button>
                <button type="button" class="btn btn-outline-secondary range-btn" data-hours="6">Last 6h</button>
                <button type="button" class="btn btn-outline-secondary range-btn" data-hours="12">Last 12h</button>
                <button type="button" class="btn btn-outline-secondary range-btn" data-hours="24">Full day</button>
            </div>
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label for="fromTime" class="form-label">From (HH:mm)</label>
                    <input type="time" id="fromTime" class="form-control"/>
                </div>
                <div class="col-md-3">
                    <label for="toTime" class="form-label">To (HH:mm)</label>
                    <input type="time" id="toTime" class="form-control"/>
                </div>
                <div class="col-md-3">
                    <button id="applyCustomRange" class="btn btn-primary" type="button">Apply Range</button>
                </div>
                <div class="col-md-3">
                    <button id="clearRange" class="btn btn-outline-secondary" type="button">Clear</button>
                </div>
            </div>
            <div id="rangeMeta" class="small text-muted mt-2"></div>
        </div>
    </div>
    
    <div class="row g-3" style="margin-top: 0;">
        <!-- Heatmap on Left -->
        <div class="col-lg-5">
            <div class="card" style="height: 100%; border-top-left-radius: 0;">
                <div class="card-header">
                    <h5>Average Pressure Heat Map</h5>
                </div>
                <div class="card-body" style="display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 8px;">
                        <span class="small" style="margin-right: 8px;">Low (0)</span>
                        <div style="width: 150px; height: 15px; background: linear-gradient(to right, hsl(240, 100%, 50%), hsl(180, 100%, 50%), hsl(120, 100%, 50%), hsl(60, 100%, 50%), hsl(0, 100%, 50%));"></div>
                        <span class="small" style="margin-left: 8px;">High (256)</span>
                    </div>
                    <div class="text-center" style="flex-grow: 1; display: flex; align-items: center; justify-content: center;">
                        <h5 id="hidden-canvas-error" hidden>An error occurred loading the heat map for this time range.</h5>
                        <canvas id="heatmapCanvas" style="border: 1px solid #ccc;"></canvas>
                    </div>
                    <div class="mt-3">
                        <div class="row small">
                            <div class="col-6">
                                <div><strong>Min Pressure:</strong> <span id="minValue">-</span></div>
                                <div><strong>Max Pressure:</strong> <span id="maxValue">-</span></div>
                                <div><strong>Average Pressure:</strong> <span id="avgValue">-</span></div>
                            </div>
                            <div class="col-6">
                                <div><strong>Pressure Range:</strong> <span id="pressureRange">-</span></div>
                                <div><strong>Hover Data:</strong> <span id="hoverValue">-</span></div>
                                <div><strong>Contact Area:</strong> <span id="contactArea">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Graph on Right -->
        <div class="col-lg-7">
            <div class="card" style="height: 100%; border-top-right-radius: 0;">
                <div class="card-header">
                    <h5>Peak Pressure Over Time</h5>
                </div>
                <div class="card-body">
                    <canvas id="peakChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-4">
        <a asp-action="Index" class="btn btn-secondary">Back to Dashboard</a>
        <a asp-controller="File" asp-action="DownloadCsv" asp-route-day="@Model.Day.ToString("yyyy-MM-dd")" class="btn btn-primary ms-2">Download CSV</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

@section Scripts {
    <script>
        // Graph script
        const day = '@Model.Day.ToString("yyyy-MM-dd")';
        let peakChart;

        // Fetch the peak data for the given day and time range selected.
        async function fetchPeakData(options = {}) {
            const params = new URLSearchParams({ day });
            if (options.hoursBack) {
                params.append('hoursBack', options.hoursBack);
            }
            if (options.from && options.to) {
                params.append('from', options.from);
                params.append('to', options.to);
            }
            const res = await fetch(`/File/getPressureGraphData?${params.toString()}`);
            if (!res.ok) return null;
            return await res.json();
        }

        // Creates the line chart
        function buildChart(labels, data) {
            const ctx = document.getElementById('peakChart').getContext('2d');

            if (peakChart) {
                peakChart.destroy();
            }

            peakChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Peak Pressure',
                        data,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13,110,253,0.15)',
                        tension: 0.35,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time (by minutes)' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Peak Pressure' }
                        }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
        }

        // Fetches and rebuilds the chart for a given day and optional range.
        async function loadDay(options = {}) {
            const result = await fetchPeakData(options);
            if (!result || result.points.length === 0) {
                buildChart([], []);
                loadHeatmap(options); // Pass options here too!
                return;
            }
            const labels = result.points.map(p => new Date(p.t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
            const values = result.points.map(p => p.v);
            buildChart(labels, values);
            
            // Also load heatmap with same time range
            loadHeatmap(options);
        }

        // Just a util to combine yyyy-MM-dd and HH:mm into ISO format
        function buildDateTime(dayStr, hhmm) {
            return `${dayStr}T${hhmm}:00`;
        }

        // Quick range buttons
        document.querySelectorAll('.range-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const hours = btn.getAttribute('data-hours');
                loadDay({ hoursBack: hours });
            });
        });

        // Custom range (From/To) in HH:mm for the selected day
        document.getElementById('applyCustomRange').addEventListener('click', () => {
            const fromVal = document.getElementById('fromTime').value;
            const toVal = document.getElementById('toTime').value;
            if (!fromVal || !toVal) return;
            loadDay({ from: buildDateTime(day, fromVal), to: buildDateTime(day, toVal) });
        });

        // Clear the custom range back to the full day
        document.getElementById('clearRange').addEventListener('click', () => {
            document.getElementById('fromTime').value = '';
            document.getElementById('toTime').value = '';
            loadDay();
        });
    </script>
        
    <script>
        // Heatmap functionality
        const heatmapCanvas = document.getElementById('heatmapCanvas');
        const heatmapCtx = heatmapCanvas.getContext('2d');

        const MAX_PRESSURE_VALUE = 256;
        const GRID_SIZE = 32;
        const CELL_PIXEL_SIZE = 15;

        heatmapCanvas.width = GRID_SIZE * CELL_PIXEL_SIZE;
        heatmapCanvas.height = GRID_SIZE * CELL_PIXEL_SIZE;

        // Color mapping function - converts value (0-256) to HSL Color
        function translateColor(pressure) {
            const adjusted = Math.min(pressure / MAX_PRESSURE_VALUE, 1.0);
            const hue = Math.floor(240 * (1 - adjusted));
            return `hsl(${hue}, 100%, 50%)`;
        }

        // Draw the heatmap
        function drawHeatmap(data) {
            heatmapCtx.clearRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);

            if (!data || data.length !== 32) {
                console.error('This data is not valid for rendering, must be a 32x32 matrix.');
                return;
            }

            let min = 257;
            let max = -1;
            let sum = 0;
            let count = 0;
            let activePixels = 0;

            for (let row = 0; row < GRID_SIZE; row++) {
                for (let col = 0; col < GRID_SIZE; col++) {
                    const value = data[row][col];
                    min = Math.min(min, value);
                    max = Math.max(max, value);
                    sum += value;
                    count++;
                    if (value > 0) activePixels++;
                }
            }

            const average = Math.round(sum / count);
            const totalPixels = GRID_SIZE * GRID_SIZE;
            const contactAreaPercentage = ((activePixels / totalPixels) * 100).toFixed(2);

            document.getElementById('minValue').textContent = min;
            document.getElementById('maxValue').textContent = max;
            document.getElementById('avgValue').textContent = average;
            document.getElementById('contactArea').textContent = `${contactAreaPercentage}%`;
            document.getElementById('pressureRange').textContent = min + " - " + max;

            for (let row = 0; row < GRID_SIZE; row++) {
                for (let col = 0; col < GRID_SIZE; col++) {
                    const value = data[row][col];
                    heatmapCtx.fillStyle = translateColor(value);
                    heatmapCtx.fillRect(col * CELL_PIXEL_SIZE, row * CELL_PIXEL_SIZE, CELL_PIXEL_SIZE, CELL_PIXEL_SIZE);
                }
            }

            heatmapCanvas.heatmapData = data;
        }

        // Handle mouse hover to show cell value
        heatmapCanvas.addEventListener('mousemove', (e) => {
            if (!heatmapCanvas.heatmapData) return;

            const rect = heatmapCanvas.getBoundingClientRect();
            const scaleX = heatmapCanvas.width / rect.width;
            const scaleY = heatmapCanvas.height / rect.height;

            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            const col = Math.floor(x / CELL_PIXEL_SIZE);
            const row = Math.floor(y / CELL_PIXEL_SIZE);

            if (row >= 0 && row < GRID_SIZE && col >= 0 && col < GRID_SIZE) {
                const value = heatmapCanvas.heatmapData[row][col];
                document.getElementById('hoverValue').textContent = `${value} (Row: ${row}, Col: ${col})`;
            }
        });

        heatmapCanvas.addEventListener('mouseleave', () => {
            document.getElementById('hoverValue').textContent = '-';
        });
        
        async function loadHeatmap(options = {}) {
            const element = document.getElementById("hidden-canvas-error");
            try {
                const params = new URLSearchParams({ day });
                if (options.hoursBack) params.append('hoursBack', options.hoursBack);
                if (options.from) params.append('from', options.from);
                if (options.to) params.append('to', options.to);
                
                const response = await fetch(`/File/getAveragePressureMap?${params}`);
                const result = await response.json();

                if (result && result.averageMap && result.averageMap.length === 32) {
                    element.hidden = true;
                    heatmapCanvas.hidden = false;
                    drawHeatmap(result.averageMap);
                } else {
                    // No data for this range - clear canvas and show message
                    element.hidden = false;
                    heatmapCanvas.hidden = true;
                    heatmapCtx.clearRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);
                    heatmapCanvas.heatmapData = null;
                    document.getElementById('minValue').textContent = '-';
                    document.getElementById('maxValue').textContent = '-';
                    document.getElementById('avgValue').textContent = '-';
                    document.getElementById('contactArea').textContent = '-';
                    document.getElementById('hoverValue').textContent = '-';
                }
            } catch (error) {
                console.error('Error loading heatmap:', error);
                element.hidden = false;
                heatmapCanvas.hidden = true;
                heatmapCtx.clearRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);
                heatmapCanvas.heatmapData = null;
                document.getElementById('minValue').textContent = '-';
                document.getElementById('maxValue').textContent = '-';
                document.getElementById('avgValue').textContent = '-';
                document.getElementById('contactArea').textContent = '-';
                document.getElementById('hoverValue').textContent = '-';
            }
        }
        
        // Initialize both graph and heatmap on page load
        loadDay();
    </script>
}

