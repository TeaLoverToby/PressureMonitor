@model Patient
@{
    ViewData["Title"] = "Patient Dashboard";
}

<style>
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }
    .dashboard-title-section {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .dashboard-title-section h1 {
        font-size: 2rem;
        font-weight: bold;
        color: #8B4513;
        margin: 0;
    }
    .dashboard-title-section p {
        margin: 0;
        color: #666;
    }
    .dashboard-stats {
        text-align: right;
    }
    .dashboard-stats div {
        font-size: 0.9rem;
    }
    
    .day-selector-section {
        margin-bottom: 20px;
    }
    .day-selector-section h3 {
        font-weight: bold;
        color: #8B4513;
        margin-bottom: 10px;
    }
    .day-selector-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    .day-boxes {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .day-box {
        min-width: 70px;
        padding: 8px 10px;
        height: auto;
        border: 2px solid #333;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.8rem;
        text-align: center;
        background: #fff;
        transition: all 0.2s;
        white-space: nowrap;
    }
    .day-box:hover {
        background: #f0f0f0;
    }
    .day-box.active {
        background: #e0e0e0;
        border-width: 3px;
    }
    .calendar-btn {
        padding: 8px 16px;
        border: 2px solid #333;
        background: #F5DEB3;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.2s;
        white-space: nowrap;
    }
    .calendar-btn:hover {
        background: #E8D4A8;
    }
    .calendar-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
        top: 0;
        left: 0;
    }
    .calendar-wrapper {
        position: relative;
        display: inline-block;
    }
    .viewing-label {
        font-size: 1.3rem;
        font-weight: bold;
        color: #333;
    }
    
    .heatmap-section, .graph-section {
        border: 2px solid #333;
        padding: 10px;
        position: relative;
        min-height: 350px;
    }
    .section-title {
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }
    .heatmap-container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .no-data-message {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        color: #666;
        font-size: 1rem;
        text-align: center;
    }
    .no-data-message.hidden {
        display: none;
    }
    
    /* Loading spinner styles */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    .loading-overlay.hidden {
        display: none;
    }
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #8B4513;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .heatmap-legend {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
    }
    .heatmap-legend span {
        font-size: 0.75rem;
    }
    .legend-gradient {
        width: 150px;
        height: 15px;
        background: linear-gradient(to right, hsl(240, 100%, 50%), hsl(180, 100%, 50%), hsl(120, 100%, 50%), hsl(60, 100%, 50%), hsl(0, 100%, 50%));
    }
    
    .metrics-section {
        border: 2px solid #333;
        padding: 15px;
        margin-top: 15px;
    }
    .metrics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .metrics-title {
        font-weight: bold;
    }
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px 20px;
    }
    .metric-item {
        font-size: 0.9rem;
    }
    .metric-item span {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .help-icon {
        width: 16px;
        height: 16px;
        border: 1px solid #333;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        cursor: help;
    }
    
    .view-details-btn {
        padding: 8px 30px;
        background: #F5DEB3;
        border: 2px solid #333;
        font-weight: bold;
        cursor: pointer;
    }
    .view-details-btn:hover {
        background: #E8D4A8;
    }
</style>

<div class="container-fluid">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="dashboard-title-section">
            <div>
                <h1>Patient Dashboard</h1>
                <p>Welcome back, @Model.User.Username!</p>
            </div>
        </div>
        <div class="dashboard-stats">
            <div><strong>Total Maps:</strong> <span id="totalMaps">-</span></div>
            <div><strong>Last Day Recorded:</strong> <span id="lastDayRecorded">-</span></div>
        </div>
    </div>
    
    <!-- Day Selector Section -->
    <div class="day-selector-section">
        <h3>Change Day</h3>
        <div class="day-selector-row">
            <div class="day-boxes" id="dayBoxes">
                <!-- Day boxes will be populated by JavaScript -->
            </div>
            <div class="calendar-wrapper">
                <input type="date" class="calendar-input" id="calendarInput" title="Choose a specific date">
                <button type="button" class="calendar-btn" id="calendarBtn" title="Choose a specific date">Choose Date</button>
            </div>
        </div>
        <div class="viewing-label">Viewing Full Day: <span id="currentViewingDay">--/--/----</span></div>
    </div>
    
    <!-- Main Content Grid -->
    <div class="row g-3">
        <!-- Heatmap Section -->
        <div class="col-md-6">
            <div class="heatmap-section h-100">
                <div class="loading-overlay hidden" id="heatmapLoading">
                    <div class="spinner"></div>
                </div>
                <div class="section-title">Heat Map Diagram - Average Pressure</div>
                <div class="heatmap-container">
                    <canvas id="heatmapCanvas"></canvas>
                    <div class="no-data-message hidden" id="heatmapNoData">No data for this day</div>
                    <div class="heatmap-legend" id="heatmapLegend">
                        <span>Low (0)</span>
                        <div class="legend-gradient"></div>
                        <span>High (255)</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Graph Section -->
        <div class="col-md-6">
            <div class="graph-section h-100">
                <div class="loading-overlay hidden" id="graphLoading">
                    <div class="spinner"></div>
                </div>
                <div class="section-title">Peak Pressure Graph</div>
                <canvas id="peakChart"></canvas>
                <div class="no-data-message hidden" id="graphNoData">No data for this day</div>
            </div>
        </div>
    </div>
    
    <!-- Key Metrics Section -->
    <div class="metrics-section">
        <div class="metrics-header">
            <div class="metrics-title">Key Metrics</div>
            <button class="view-details-btn" id="viewDetailsBtn">VIEW</button>
        </div>
        <div class="metrics-grid">
            <div class="metric-item">Lowest Pressure: <span id="minValue">-</span></div>
            <div class="metric-item">Average Pressure: <span id="avgValue">-</span></div>
            <div class="metric-item"><span><span class="help-icon">?</span> Contact Area: <span id="contactArea">-</span></span></div>
            <div class="metric-item">Highest Pressure: <span id="maxValue">-</span></div>
            <div class="metric-item">Pressure Range: <span id="pressureRange">-</span></div>
            <div class="metric-item"><span><span class="help-icon">?</span> Peak Pressure: <span id="peakPressure">-</span></span></div>
            <div class="metric-item">Duration: <span id="duration">-</span></div>
            <div class="metric-item">Hover Data: <span id="hoverValue">-</span></div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Heatmap script - must be defined first
        const heatmapCanvas = document.getElementById('heatmapCanvas');
        const heatmapCtx = heatmapCanvas.getContext('2d');
        
        const MAX_PRESSURE_VALUE = 255;
        const GRID_SIZE = 32;
        const CELL_PIXEL_SIZE = 10;
        
        heatmapCanvas.width = GRID_SIZE * CELL_PIXEL_SIZE;
        heatmapCanvas.height = GRID_SIZE * CELL_PIXEL_SIZE;
        
        // Color mapping function - converts value (0-255) to HSL Color
        // HSL from Blue (240) to Red (0)
        function translateColor(pressure) {
            const adjusted = Math.min(pressure / MAX_PRESSURE_VALUE, 1.0);
            const hue = Math.floor(240 * (1 - adjusted));
            return `hsl(${hue}, 100%, 50%)`;
        }
        
        // Draw the heatmap
        function drawHeatmap(data) {
            heatmapCtx.clearRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);
            
            if (!data || data.length !== 32) {
                console.error('Invalid data for rendering, must be a 32x32 matrix.');
                return;
            }

            let min = 257;
            let max = -1;
            let sum = 0;
            let count = 0;
            let activePixels = 0;

            for (let row = 0; row < GRID_SIZE; row++) {
                for (let col = 0; col < GRID_SIZE; col++) {
                    const value = data[row][col];
                    min = Math.min(min, value);
                    max = Math.max(max, value);
                    sum += value;
                    count++;
                    if (value > 0) activePixels++;
                }
            }

            const average = Math.round(sum / count);
            const totalPixels = GRID_SIZE * GRID_SIZE;
            const contactAreaPercentage = ((activePixels / totalPixels) * 100).toFixed(1);

            document.getElementById('minValue').textContent = min;
            document.getElementById('maxValue').textContent = max;
            document.getElementById('avgValue').textContent = average;
            document.getElementById('pressureRange').textContent = min + " - " + max;
            document.getElementById('contactArea').textContent = `${contactAreaPercentage}%`;

            for (let row = 0; row < GRID_SIZE; row++) {
                for (let col = 0; col < GRID_SIZE; col++) {
                    const value = data[row][col];
                    heatmapCtx.fillStyle = translateColor(value);
                    heatmapCtx.fillRect(col * CELL_PIXEL_SIZE, row * CELL_PIXEL_SIZE, CELL_PIXEL_SIZE, CELL_PIXEL_SIZE);
                }
            }
            
            heatmapCanvas.heatmapData = data;
        }
        
        // Handle mouse hover to show cell value
        heatmapCanvas.addEventListener('mousemove', (e) => {
            if (!heatmapCanvas.heatmapData) return;
            
            const rect = heatmapCanvas.getBoundingClientRect();
            const scaleX = heatmapCanvas.width / rect.width;
            const scaleY = heatmapCanvas.height / rect.height;
            
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            const col = Math.floor(x / CELL_PIXEL_SIZE);
            const row = Math.floor(y / CELL_PIXEL_SIZE);
            
            if (row >= 0 && row < GRID_SIZE && col >= 0 && col < GRID_SIZE) {
                const value = heatmapCanvas.heatmapData[row][col];
                document.getElementById('hoverValue').textContent = `${value} (Row: ${row}, Col: ${col})`;
            }
        });
        
        heatmapCanvas.addEventListener('mouseleave', () => {
            document.getElementById('hoverValue').textContent = '-';
        });
        
        // Loading spinner functions
        function showLoading(elementId) {
            document.getElementById(elementId)?.classList.remove('hidden');
        }
        function hideLoading(elementId) {
            document.getElementById(elementId)?.classList.add('hidden');
        }

        // Load heatmap for the given day
        async function loadHeatmap(day, options = {}) {
            showLoading('heatmapLoading');
            try {
                const params = new URLSearchParams({ day });
                if (options.hoursBack) params.append('hoursBack', options.hoursBack);
                if (options.from) params.append('from', options.from);
                if (options.to) params.append('to', options.to);
                
                const response = await fetch(`/File/getAveragePressureMap?${params}`);
                const result = await response.json();
                
                if (result && result.averageMap && result.averageMap.length === 32) {
                    hideHeatmapNoData();
                    drawHeatmap(result.averageMap);
                    
                    // Display duration from frame count
                    if (result.durationSeconds !== undefined) {
                        const totalSeconds = result.durationSeconds;
                        const minutes = Math.floor(totalSeconds / 60);
                        const seconds = totalSeconds % 60;
                        document.getElementById('duration').textContent = `${minutes}m ${seconds}s`;
                    } else {
                        document.getElementById('duration').textContent = '-';
                    }
                } else {
                    showHeatmapNoData();
                }
            } catch (error) {
                showHeatmapNoData();
                console.error('Error loading heatmap:', error);
            } finally {
                hideLoading('heatmapLoading');
            }
        }
        
        function clearHeatmapDisplay() {
            heatmapCtx.clearRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);
            heatmapCanvas.heatmapData = null;
            document.getElementById('minValue').textContent = '-';
            document.getElementById('maxValue').textContent = '-';
            document.getElementById('avgValue').textContent = '-';
            document.getElementById('pressureRange').textContent = '-';
            document.getElementById('contactArea').textContent = '-';
            document.getElementById('peakPressure').textContent = '-';
            document.getElementById('duration').textContent = '-';
            document.getElementById('hoverValue').textContent = '-';
        }
        
        function showHeatmapNoData() {
            heatmapCanvas.style.display = 'none';
            document.getElementById('heatmapNoData').classList.remove('hidden');
            document.getElementById('heatmapLegend').style.display = 'none';
            clearHeatmapDisplay();
        }
        
        function hideHeatmapNoData() {
            heatmapCanvas.style.display = 'block';
            document.getElementById('heatmapNoData').classList.add('hidden');
            document.getElementById('heatmapLegend').style.display = 'flex';
        }
        
        function showGraphNoData() {
            document.getElementById('peakChart').style.display = 'none';
            document.getElementById('graphNoData').classList.remove('hidden');
        }
        
        function hideGraphNoData() {
            document.getElementById('peakChart').style.display = 'block';
            document.getElementById('graphNoData').classList.add('hidden');
        }

        // Graph script
        let peakChart;
        let allDays = [];
        let currentDayIndex = 0;
        let currentPeakValue = 0;

        // Get the days for which there is a pressure map for the patient
        async function fetchDays() {
            const res = await fetch('/File/GetMapDays');
            if (!res.ok) return [];
            return await res.json();
        }

        // Fetch the peak data for the given day and time range selected.
        async function fetchPeakData(day, options = {}) {
            const params = new URLSearchParams({ day });
            if (options.hoursBack) {
                params.append('hoursBack', options.hoursBack);
            }
            if (options.from && options.to) {
                params.append('from', options.from);
                params.append('to', options.to);
            }
            const res = await fetch(`/File/getPressureGraphData?${params.toString()}`);
            if (!res.ok) return null;
            return await res.json();
        }

        // Format date from yyyy-MM-dd to MM/DD/YYYY
        function formatDateDisplay(dateStr) {
            if (!dateStr) return '--/--/----';
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            return `${parts[1]}/${parts[2]}/${parts[0]}`;
        }

        // Build the day selection boxes
        function buildDayBoxes(days) {
            const container = document.getElementById('dayBoxes');
            container.innerHTML = '';
            
            // Show up to 8 most recent days
            const displayDays = days.slice(0, 8);
            
            displayDays.forEach((day, index) => {
                const box = document.createElement('div');
                box.className = 'day-box' + (index === 0 ? ' active' : '');
                box.textContent = formatDateDisplay(day);
                box.dataset.day = day;
                box.dataset.index = index;
                box.addEventListener('click', () => selectDay(index));
                container.appendChild(box);
            });
        }

        // Select a specific day
        function selectDay(index) {
            if (index < 0 || index >= allDays.length) return;
            
            currentDayIndex = index;
            const day = allDays[index];
            
            // Update active state on day boxes
            document.querySelectorAll('.day-box').forEach((box, i) => {
                box.classList.toggle('active', i === index);
            });
            
            // Update viewing label
            document.getElementById('currentViewingDay').textContent = formatDateDisplay(day);
            
            // Load data for selected day
            loadDay(day);
        }
        
        // Select a custom day (from calendar input)
        function selectCustomDay(day) {
            // Update viewing label
            document.getElementById('currentViewingDay').textContent = formatDateDisplay(day);
            
            // Check if this day is in our available days and update active state
            const dayIndex = allDays.indexOf(day);
            if (dayIndex !== -1) {
                currentDayIndex = dayIndex;
                document.querySelectorAll('.day-box').forEach((box, i) => {
                    box.classList.toggle('active', i === dayIndex);
                });
            } else {
                // Deactivate all day boxes since this is a custom date
                document.querySelectorAll('.day-box').forEach(box => {
                    box.classList.remove('active');
                });
                currentDayIndex = -1;
            }
            
            // Load data for selected day (will show "no data" if day doesn't exist)
            loadDay(day);
        }

        // Creates the line chart
        function buildChart(labels, data) {
            const ctx = document.getElementById('peakChart').getContext('2d');

            if (peakChart) {
                peakChart.destroy();
            }

            peakChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Peak Pressure',
                        data,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13,110,253,0.15)',
                        tension: 0.35,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time (in minutes)' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Peak Pressure' }
                        }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
            
            // Update peak pressure metric
            if (data.length > 0) {
                currentPeakValue = Math.max(...data);
                document.getElementById('peakPressure').textContent = currentPeakValue;
            }
        }

        // Fetches and rebuilds the chart for a given day
        async function loadDay(day, options = {}) {
            // Load chart and heatmap independently (don't wait for each other)
            loadGraph(day, options);
            loadHeatmap(day, options);
        }
        
        // Load just the graph
        async function loadGraph(day, options = {}) {
            showLoading('graphLoading');
            try {
                const peakResult = await fetchPeakData(day, options);
                
                if (!peakResult || !peakResult.points || peakResult.points.length === 0) {
                    // Destroy existing chart first
                    if (peakChart) {
                        peakChart.destroy();
                        peakChart = null;
                    }
                    
                    showGraphNoData();
                    document.getElementById('peakPressure').textContent = '-';
                    return;
                }
                
                hideGraphNoData();
                const labels = peakResult.points.map(p => new Date(p.t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                const values = peakResult.points.map(p => p.v);
                buildChart(labels, values);
            } catch (error) {
                console.error('Error loading graph:', error);
                // Destroy existing chart on error
                if (peakChart) {
                    peakChart.destroy();
                    peakChart = null;
                }
                showGraphNoData();
                document.getElementById('peakPressure').textContent = '-';
            } finally {
                hideLoading('graphLoading');
            }
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            allDays = await fetchDays();
            
            if (allDays.length === 0) {
                document.getElementById('dayBoxes').innerHTML = '<div class="day-box">No data</div>';
                document.getElementById('totalMaps').textContent = '0';
                document.getElementById('lastDayRecorded').textContent = '--/--/----';
                buildChart([], []);
                return;
            }

            // Update stats
            document.getElementById('totalMaps').textContent = allDays.length;
            document.getElementById('lastDayRecorded').textContent = formatDateDisplay(allDays[0]);

            // Build day selection boxes
            buildDayBoxes(allDays);

            // Load the most recent day
            selectDay(0);
        });
        
        // Calendar button functionality
        document.getElementById('calendarBtn')?.addEventListener('click', () => {
            document.getElementById('calendarInput')?.click();
        });
        
        document.getElementById('calendarInput')?.addEventListener('change', (e) => {
            const selectedDate = e.target.value; // Format: yyyy-MM-dd
            if (selectedDate) {
                selectCustomDay(selectedDate);
            }
        });
        
        // View details button
        document.getElementById('viewDetailsBtn')?.addEventListener('click', () => {
            if (allDays.length > 0 && currentDayIndex >= 0 && currentDayIndex < allDays.length) {
                window.location.href = `/Patient/ViewPressureMap?day=${allDays[currentDayIndex]}`;
            } else {
                // If viewing a custom date, get it from the label
                const currentDay = document.getElementById('currentViewingDay').textContent;
                if (currentDay !== '--/--/----') {
                    // Convert MM/DD/YYYY back to yyyy-MM-dd
                    const parts = currentDay.split('/');
                    if (parts.length === 3) {
                        const isoDate = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                        window.location.href = `/Patient/ViewPressureMap?day=${isoDate}`;
                    }
                }
            }
        });
    </script>
}
