@model Patient
@{
    ViewData["Title"] = "Patient Dashboard";
}

<!-- Decided to move most of the style code into a CSS file to prevent HTML getting messy -->
<style>
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }
    .dashboard-title-section {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .dashboard-title-section h1 {
        font-size: 2rem;
        font-weight: bold;
        color: #13438b;
        margin: 0;
    }
    .dashboard-title-section p {
        margin: 0;
        color: #666;
    }
    .dashboard-stats {
        text-align: right;
    }
    .dashboard-stats div {
        font-size: 0.9rem;
    }
    
    .day-selector-section {
        margin-bottom: 20px;
    }
    .day-selector-section h3 {
        font-weight: bold;
        color: #13438b;
        margin-bottom: 10px;
    }
    .day-selector-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    .day-boxes {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .day-box {
        min-width: 70px;
        padding: 8px 10px;
        height: auto;
        border: 2px solid #333;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.8rem;
        text-align: center;
        background: #fff;
        transition: all 0.2s;
        white-space: nowrap;
    }
    .day-box:hover {
        background: #f0f0f0;
    }
    .day-box.active {
        background: #e0e0e0;
        border-width: 3px;
    }
    .calendar-btn {
        padding: 8px 16px;
        border: 2px solid #333;
        background: #3478dd;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.2s;
        white-space: nowrap;
    }
    .calendar-btn:hover {
        background: #13438b;
    }
    .calendar-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
        top: 0;
        left: 0;
    }
    .calendar-wrapper {
        position: relative;
        display: inline-block;
    }
    .viewing-label {
        font-size: 1.3rem;
        font-weight: bold;
        color: #333;
    }
    
    .heatmap-section, .graph-section {
        border: 2px solid #333;
        padding: 10px;
        position: relative;
        min-height: 350px;
    }
    .section-title {
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }
    .heatmap-container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .no-data-message {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        color: #666;
        font-size: 1rem;
        text-align: center;
    }
    .no-data-message.hidden {
        display: none;
    }
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    .loading-overlay.hidden {
        display: none;
    }
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #13438b;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .heatmap-legend {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
    }
    .heatmap-legend span {
        font-size: 0.75rem;
    }
    .legend-gradient {
        width: 150px;
        height: 15px;
        background: linear-gradient(to right, hsl(240, 100%, 50%), hsl(180, 100%, 50%), hsl(120, 100%, 50%), hsl(60, 100%, 50%), hsl(0, 100%, 50%));
    }
    
    .metrics-section {
        border: 2px solid #333;
        padding: 15px;
        margin-top: 15px;
    }
    .metrics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .metrics-title {
        font-weight: bold;
    }
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px 20px;
    }
    .metric-item {
        font-size: 0.9rem;
    }
    .metric-item span {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .help-icon {
        width: 16px;
        height: 16px;
        border: 1px solid #333;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        cursor: help;
    }
    
    .view-details-btn {
        padding: 8px 30px;
        background: #cca808;
        border: 2px solid #333;
        font-weight: bold;
        cursor: pointer;
    }
    .view-details-btn:hover {
        background: #e7e07b;
    }
    
    /* Comments Section Styles */
    .main-content-layout {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
    }
    @@media (max-width: 992px) {
        .main-content-layout {
            grid-template-columns: 1fr;
        }
    }
    .left-content {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .right-sidebar {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .comments-section {
        border: 2px solid #333;
        padding: 15px;
        display: flex;
        flex-direction: column;
    }
    .comments-title {
        font-weight: bold;
        padding-bottom: 10px;
        border-bottom: 1px solid #333;
        margin-bottom: 15px;
    }
    .comments-list {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 15px;
        max-height: 200px;
    }
    .comment-item {
        margin-bottom: 15px;
    }
    .comment-author {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 5px;
    }
    .author-icon {
        width: 24px;
        height: 24px;
        border: 1px solid #333;
        border-radius: 50%;
    }
    .comment-text {
        padding: 8px 12px;
        border: 1px solid #ccc;
        background: #f9f9f9;
        font-size: 0.85rem;
        margin-bottom: 5px;
        display: inline-block;
    }
    .comment-row {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .reply-btn {
        padding: 5px 15px;
        border: 2px solid #333;
        background: #fff;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.85rem;
    }
    .reply-btn:hover {
        background: #f0f0f0;
    }
    .heatmap-link {
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .heatmap-link a {
        text-decoration: underline;
    }
    .view-heatmap-btn {
        padding: 3px 10px;
        border: 2px solid #333;
        background: #fff;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.75rem;
    }
    .view-heatmap-btn:hover {
        background: #f0f0f0;
    }
    .new-comment-section {
        border-top: 1px solid #ccc;
        padding-top: 15px;
    }
    .new-comment-section label {
        font-size: 0.85rem;
        margin-bottom: 5px;
        display: block;
    }
    .new-comment-section textarea {
        width: 100%;
        height: 60px;
        border: 1px solid #ccc;
        padding: 8px;
        margin-bottom: 10px;
        resize: none;
    }
    .comment-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .flag-checkbox {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.85rem;
    }
    .flag-checkbox label {
        display: flex;
        align-items: center;
        gap: 5px;
        margin: 0;
    }
    .send-btn {
        padding: 8px 25px;
        border: 2px solid #333;
        background: #fff;
        font-weight: bold;
        cursor: pointer;
    }
    .send-btn:hover {
        background: #f0f0f0;
    }
</style>

<div class="container-fluid">
    <div class="dashboard-header">
        <div class="dashboard-title-section">
            <div>
                <h1>Patient Dashboard</h1>
                <p>Welcome back, @Model.User.Username!</p>
            </div>
        </div>
        <div class="dashboard-stats">
            <div><strong>Total Maps:</strong> <span id="totalMaps">-</span></div>
            <div><strong>Last Day Recorded:</strong> <span id="lastDayRecorded">-</span></div>
        </div>
    </div>
    
    <div class="day-selector-section">
        <h3>Change Day</h3>
        <div class="day-selector-row">
            <div class="day-boxes" id="dayBoxes"></div>
            <div class="calendar-wrapper">
                <input type="date" class="calendar-input" id="calendarInput" title="Choose a specific date">
                <button type="button" class="calendar-btn" id="calendarBtn" title="Choose a specific date">Choose Date</button>
            </div>
        </div>
        <div class="viewing-label">Viewing Full Day: <span id="currentViewingDay">--/--/----</span></div>
    </div>
    
    <div class="main-content-layout">
        <div class="left-content">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="heatmap-section h-100">
                        <div class="loading-overlay hidden" id="heatmapLoading">
                            <div class="spinner"></div>
                        </div>
                        <div class="section-title">Heat Map Diagram - Average Pressure</div>
                        <div class="heatmap-container">
                            <canvas id="heatmapCanvas"></canvas>
                            <div class="no-data-message hidden" id="heatmapNoData">No data for this day</div>
                            <div class="heatmap-legend" id="heatmapLegend">
                                <span>Low (0)</span>
                                <div class="legend-gradient"></div>
                                <span>High (255)</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="graph-section h-100">
                        <div class="loading-overlay hidden" id="graphLoading">
                            <div class="spinner"></div>
                        </div>
                        <div class="section-title">Peak Pressure Graph</div>
                        <canvas id="peakChart"></canvas>
                        <div class="no-data-message hidden" id="graphNoData">No data for this day</div>
                    </div>
                </div>
            </div>
            
            <div class="metrics-section">
                <div class="metrics-header">
                    <div class="metrics-title">Key Metrics</div>
                    <button class="view-details-btn" id="viewDetailsBtn">VIEW</button>
                </div>
                <div class="metrics-grid">
                    <div class="metric-item">Lowest Pressure: <span id="minValue">-</span></div>
                    <div class="metric-item">Average Pressure: <span id="avgValue">-</span></div>
                    <div class="metric-item"><span><span class="help-icon">?</span> Contact Area: <span id="contactArea">-</span></span></div>
                    <div class="metric-item">Highest Pressure: <span id="maxValue">-</span></div>
                    <div class="metric-item">Pressure Range: <span id="pressureRange">-</span></div>
                    <div class="metric-item"><span><span class="help-icon">?</span> Peak Pressure: <span id="peakPressure">-</span></span></div>
                    <div class="metric-item">Duration: <span id="duration">-</span></div>
                    <div class="metric-item">Hover Data: <span id="hoverValue">-</span></div>
                </div>
            </div>
        </div>
        
        <!-- Right Sidebar: Comments Section -->
        <div class="right-sidebar">
            <div class="comments-section">
                <div class="comments-title">Recent Comments</div>
                <div class="comments-list" id="commentsList">
                    <!-- Example comment - will be populated dynamically -->
                    <div class="comment-item">
                        <div class="comment-author">
                            <div class="author-icon"></div>
                            <strong>Example Clinician</strong>
                        </div>
                        <div class="comment-row">
                            <div class="comment-text">Example feedback...</div>
                            <button class="reply-btn">Reply</button>
                        </div>
                        <div class="heatmap-link">
                            Heatmap: <a href="#">XX/XX/XXXX</a>
                            <button class="view-heatmap-btn">VIEW</button>
                        </div>
                    </div>
                </div>
                
                <div class="new-comment-section">
                    <label>Comment about current data...</label>
                    <textarea id="commentInput" placeholder="..."></textarea>
                    <div class="comment-actions">
                        <div class="flag-checkbox">
                            <label>
                                <input type="checkbox" id="urgentFlag">
                                Flag for urgent review
                            </label>
                        </div>
                        <button class="send-btn" id="sendCommentBtn">SEND</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Heatmap script
        const heatmapCanvas = document.getElementById('heatmapCanvas');
        const heatmapCtx = heatmapCanvas.getContext('2d');
        
        const MAX_PRESSURE_VALUE = 255;
        const GRID_SIZE = 32;
        const CELL_PIXEL_SIZE = 10;
        
        heatmapCanvas.width = GRID_SIZE * CELL_PIXEL_SIZE;
        heatmapCanvas.height = GRID_SIZE * CELL_PIXEL_SIZE;

        // TODO: Might change the color wheel selection later - looks a bit ugly
        
        // Color mapping function - converts value (0-255) to HSL Color
        // HSL from Blue (240) to Red (0)
        function translateColor(pressure) {
            const adjusted = Math.min(pressure / MAX_PRESSURE_VALUE, 1.0);
            const hue = Math.floor(240 * (1 - adjusted));
            return `hsl(${hue}, 100%, 50%)`;
        }
        
        // Draw the heatmap
        function drawHeatmap(data) {
            // Clear prior drawing (incase there was a prior heat map)
            heatmapCtx.clearRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);
            
            if (!data || data.length !== 32) {
                console.error('Invalid data for rendering, must be a 32x32 matrix.');
                return;
            }

            // We know that the value range is 0 - 256 so we can define min/max.
            let min = 257;
            let max = -1;
            let sum = 0;
            let count = 0;
            let activePixels = 0;

            for (let row = 0; row < GRID_SIZE; row++) {
                for (let col = 0; col < GRID_SIZE; col++) {
                    const value = data[row][col];
                    min = Math.min(min, value);
                    max = Math.max(max, value);
                    sum += value;
                    count++;
                    if (value > 0) activePixels++;
                }
            }

            const average = Math.round(sum / count);
            const totalPixels = GRID_SIZE * GRID_SIZE;
            const contactAreaPercentage = ((activePixels / totalPixels) * 100).toFixed(1);

            document.getElementById('minValue').textContent = min;
            document.getElementById('maxValue').textContent = max;
            document.getElementById('avgValue').textContent = average;
            document.getElementById('pressureRange').textContent = min + " - " + max;
            document.getElementById('contactArea').textContent = `${contactAreaPercentage}%`;

            for (let row = 0; row < GRID_SIZE; row++) {
                for (let col = 0; col < GRID_SIZE; col++) {
                    const value = data[row][col];
                    heatmapCtx.fillStyle = translateColor(value);
                    heatmapCtx.fillRect(col * CELL_PIXEL_SIZE, row * CELL_PIXEL_SIZE, CELL_PIXEL_SIZE, CELL_PIXEL_SIZE);
                }
            }
            
            // Cache the matrix data for the hover logic
            heatmapCanvas.heatmapData = data;
        }
        
        // Handle mouse hover to show cell value
        heatmapCanvas.addEventListener('mousemove', (e) => {
            if (!heatmapCanvas.heatmapData) return;
            
            // We need to check if the mouse location is within the canvas
            const rect = heatmapCanvas.getBoundingClientRect();
            const scaleX = heatmapCanvas.width / rect.width;
            const scaleY = heatmapCanvas.height / rect.height;
            
            // Get mouse position relative to canvas
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            // By dividing, we can find the cell indices
            const col = Math.floor(x / CELL_PIXEL_SIZE);
            const row = Math.floor(y / CELL_PIXEL_SIZE);
            
            // Ensure that the indicies are within the bounds
            if (row >= 0 && row < GRID_SIZE && col >= 0 && col < GRID_SIZE) {
                // Check the matrix data for the pressure value
                const value = heatmapCanvas.heatmapData[row][col];
                document.getElementById('hoverValue').textContent = `${value} (Row: ${row}, Col: ${col})`;
            }
        });
        
        heatmapCanvas.addEventListener('mouseleave', () => {
            document.getElementById('hoverValue').textContent = '-';
        });
        
        // Loading spinner functions
        function showLoading(elementId) {
            document.getElementById(elementId)?.classList.remove('hidden');
        }
        function hideLoading(elementId) {
            document.getElementById(elementId)?.classList.add('hidden');
        }

        // Load heatmap for the given day
        async function loadHeatmap(day, options = {}) {
            showLoading('heatmapLoading');
            try {
                const params = new URLSearchParams({ day });
                if (options.hoursBack) params.append('hoursBack', options.hoursBack);
                if (options.from) params.append('from', options.from);
                if (options.to) params.append('to', options.to);
                
                const response = await fetch(`/File/getAveragePressureMap?${params}`);
                const result = await response.json();
                
                // Gets the matrix data of the average map
                if (result && result.averageMap && result.averageMap.length === 32) {
                    hideHeatmapNoData();
                    drawHeatmap(result.averageMap);
                    
                    // Display duration from frame count
                    if (result.durationSeconds !== undefined) {
                        const totalSeconds = result.durationSeconds;
                        const minutes = Math.floor(totalSeconds / 60);
                        const seconds = totalSeconds % 60;
                        document.getElementById('duration').textContent = `${minutes}m ${seconds}s`;
                    } else {
                        document.getElementById('duration').textContent = '-';
                    }
                } else {
                    // No data for this range - clear the canvas and show this message
                    showHeatmapNoData();
                }
            } catch (error) {
                // Error occurred - clear the canvas and show no data message
                showHeatmapNoData();
                console.error('Error loading heatmap:', error);
            } finally {
                hideLoading('heatmapLoading');
            }
        }
        
        function clearHeatmapDisplay() {
            // Clear everything!!!
            heatmapCtx.clearRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);
            heatmapCanvas.heatmapData = null;
            document.getElementById('minValue').textContent = '-';
            document.getElementById('maxValue').textContent = '-';
            document.getElementById('avgValue').textContent = '-';
            document.getElementById('pressureRange').textContent = '-';
            document.getElementById('contactArea').textContent = '-';
            document.getElementById('peakPressure').textContent = '-';
            document.getElementById('duration').textContent = '-';
            document.getElementById('hoverValue').textContent = '-';
        }
        
        function showHeatmapNoData() {
            // By removing the hidden tag, the no data tag should now appear.
            heatmapCanvas.style.display = 'none';
            document.getElementById('heatmapNoData').classList.remove('hidden');
            document.getElementById('heatmapLegend').style.display = 'none';
            clearHeatmapDisplay();
        }
        
        function hideHeatmapNoData() {
            // Now we hide the no data message and show the canvas
            heatmapCanvas.style.display = 'block';
            document.getElementById('heatmapNoData').classList.add('hidden');
            document.getElementById('heatmapLegend').style.display = 'flex';
        }
        
        function showGraphNoData() {
            // Hide the graph and show the no data message
            document.getElementById('peakChart').style.display = 'none';
            document.getElementById('graphNoData').classList.remove('hidden');
        }
        
        function hideGraphNoData() {
            // Show the graph and hide the no data message
            document.getElementById('peakChart').style.display = 'block';
            document.getElementById('graphNoData').classList.add('hidden');
        }

        // Graph script
        let peakChart;
        let allDays = [];
        let currentDayIndex = 0;
        let currentPeakValue = 0;

        // Get the days for which there is a pressure map for the patient
        async function fetchDays() {
            const res = await fetch('/File/GetMapDays');
            if (!res.ok) return [];
            return await res.json();
        }

        // Fetch the peak data for the given day and time range selected.
        // The data received is JSON and follows format of day, rangeStart, rangeEnd and points[]
        async function fetchPeakData(day, options = {}) {
            const params = new URLSearchParams({ day });
            if (options.hoursBack) {
                params.append('hoursBack', options.hoursBack);
            }
            if (options.from && options.to) {
                params.append('from', options.from);
                params.append('to', options.to);
            }
            // Calls the backend method and follows the parameters
            const res = await fetch(`/File/getPressureGraphData?${params.toString()}`);
            if (!res.ok) return null;
            return await res.json();
        }

        // Just formats the date from yyyy-MM-dd to MM/DD/YYYY
        function formatDateDisplay(dateStr) {
            if (!dateStr) return '--/--/----'; // empty placeholder
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            return `${parts[1]}/${parts[2]}/${parts[0]}`;
        }

        // Build the day selection boxes
        function buildDayBoxes(days) {
            const container = document.getElementById('dayBoxes');
            container.innerHTML = '';
            
            // Show up to 8 most recent days
            const displayDays = days.slice(0, 8);
            
            displayDays.forEach((day, index) => {
                // Create the day box element
                const box = document.createElement('div');
                box.className = 'day-box' + (index === 0 ? ' active' : '');
                box.textContent = formatDateDisplay(day);
                box.dataset.day = day;
                box.dataset.index = index;
                box.addEventListener('click', () => selectDay(index));
                container.appendChild(box);
            });
        }

        // Select a specific day
        function selectDay(index) {
            if (index < 0 || index >= allDays.length) return;
            
            currentDayIndex = index;
            const day = allDays[index];
            
            // Update active state on day boxes (highlights selected day)
            document.querySelectorAll('.day-box').forEach((box, i) => {
                box.classList.toggle('active', i === index);
            });
            
            // Update the view message
            document.getElementById('currentViewingDay').textContent = formatDateDisplay(day);
            
            // Load data for selected day
            loadDay(day);
        }
        
        // Select a custom day from the calendar input
        function selectCustomDay(day) {
            // Update viewing message
            document.getElementById('currentViewingDay').textContent = formatDateDisplay(day);
            
            // Check the day entered is linked to a button, if so then we can highlight it
            const dayIndex = allDays.indexOf(day);
            if (dayIndex !== -1) {
                currentDayIndex = dayIndex;
                document.querySelectorAll('.day-box').forEach((box, i) => {
                    box.classList.toggle('active', i === dayIndex);
                });
            } else {
                // Make sure that no day boxes are active/highlighted
                document.querySelectorAll('.day-box').forEach(box => {
                    box.classList.remove('active');
                });
                currentDayIndex = -1;
            }
            
            // Load data for selected day
            loadDay(day);
        }

        /* 
            Creates the line chart
            Labels - array of string labels for the X axis
            Data - array of numeric values for the Y axis
        */
        function buildChart(labels, data) {
            const ctx = document.getElementById('peakChart').getContext('2d');

            // If a previous one exists, we remove it first
            if (peakChart) {
                peakChart.destroy();
            }

            // Followed docuementation from the Chart.js website
            peakChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Peak Pressure',
                        data,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13,110,253,0.15)',
                        tension: 0.35,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time (in minutes)' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Peak Pressure' }
                        }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
        }

        // Fetches and rebuilds the chart/heatmap for the given day
        async function loadDay(day, options = {}) {
            // Big change from prior version, we now load graph and heatmap independently so they don't block each other
            loadGraph(day, options);
            loadHeatmap(day, options);
        }
        
        // Load just the graph
        async function loadGraph(day, options = {}) {
            showLoading('graphLoading');
            try {
                const peakResult = await fetchPeakData(day, options);
                
                if (!peakResult || !peakResult.points || peakResult.points.length === 0) {
                    // Destroy existing chart first
                    if (peakChart) {
                        peakChart.destroy();
                        peakChart = null;
                    }
                    
                    showGraphNoData();
                    return;
                }
                
                hideGraphNoData();
                const labels = peakResult.points.map(p => new Date(p.t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                const values = peakResult.points.map(p => p.v);
                buildChart(labels, values);
                
                // Update peak pressure metric
                if (values.length > 0) {
                    currentPeakValue = Math.max(...values);
                    document.getElementById('peakPressure').textContent = currentPeakValue;
                } else {
                    document.getElementById('peakPressure').textContent = '-';
                }
            } catch (error) {
                console.error('Error loading graph:', error);
                // Destroy existing chart if there is an error
                if (peakChart) {
                    peakChart.destroy();
                    peakChart = null;
                }
                showGraphNoData();
            } finally {
                // Removes the loading spinner
                hideLoading('graphLoading');
            }
        }

        // When the page is loaded, the available days are fetched and loaded into the select boxes
        document.addEventListener('DOMContentLoaded', async () => {
            allDays = await fetchDays();
            if (allDays.length === 0) {
                document.getElementById('dayBoxes').innerHTML = '<div class="day-box">No data</div>';
                document.getElementById('totalMaps').textContent = '0';
                document.getElementById('lastDayRecorded').textContent = '--/--/----';
                buildChart([], []);
                return;
            }
            document.getElementById('totalMaps').textContent = allDays.length;
            document.getElementById('lastDayRecorded').textContent = formatDateDisplay(allDays[0]);

            // Build day selection boxes - might not be necessary?
            buildDayBoxes(allDays);

            // Since the page is being loaded, we select the most recent day by default
            selectDay(0);
        });
        
        // Calendar button logic
        document.getElementById('calendarBtn')?.addEventListener('click', () => {
            document.getElementById('calendarInput')?.click();
        });
        
        document.getElementById('calendarInput')?.addEventListener('change', (e) => {
            // Fetches in the format yyyy-MM-dd
            const selectedDate = e.target.value;
            if (selectedDate) {
                selectCustomDay(selectedDate);
            }
        });
        
        // View details button
        document.getElementById('viewDetailsBtn')?.addEventListener('click', () => {
            // Get day from current selection or custom date
            const day = (currentDayIndex >= 0 && currentDayIndex < allDays.length) ? allDays[currentDayIndex] : document.getElementById('calendarInput')?.value;
            
            if (day) {
                window.location.href = `/Patient/ViewPressureMap?day=${day}`;
            }
        });
    </script>
}
